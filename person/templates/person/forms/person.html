{% load crispy_forms_tags %}
<form method="POST" enctype="multipart/form-data" id="form">
  {% csrf_token %}
  <ul class="nav nav-pills" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <a class="nav-link active" 
        id="basic-tab" 
        data-toggle="tab" 
        href="#basic" 
        role="tab" 
        aria-controls="basic"
        aria-selected="true">
        Basic
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" 
        id="contact-tab" 
        data-toggle="tab"
        href="#contact" 
        role="tab" 
        aria-controls="contact"
        aria-selected="false">
        Contacts
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" 
        id="address-tab" 
        data-toggle="tab" 
        href="#address" 
        role="tab" 
        aria-controls="address"
        aria-selected="false">
        Address
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" 
        id="other-tab" 
        data-toggle="tab" 
        href="#other" 
        role="tab" 
        aria-controls="other"
        aria-selected="false">
        Others
      </a>
    </li>
  </ul>

  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" 
      id="basic" 
      role="tabpanel" 
      aria-labelledby="basic-tab">
      <br>
      {% if not to_create %}
      <div class="row">
        <div class="col-8">
          {{ person_form.center | as_crispy_field }}
        </div>
        <div class="col-4">
          {{ person_form.person_type | as_crispy_field }}
        </div>
      </div>
      {% endif %}
      <div class="row">
        <div class="col-{% if not to_create %}8{% else %}12{% endif %}">
          {{ person_form.name | as_crispy_field }}
        </div>
        {% if not to_create %}
        <div class="col-4">
          {{ person_form.reg | as_crispy_field }}
        </div>
        {% endif %}
      </div>
      <div class="row">
        <div class="col-6">
          {{ profile_form.social_name | as_crispy_field }}
        </div>
        <div class="col-6">
          {{ user_form.email | as_crispy_field }}
        </div>
      </div>
      <div class="row">
        <div class="col-7">
          {{ profile_form.image | as_crispy_field }}
        </div>
      </div>
    </div>

    <div class="tab-pane fade" 
      id="contact" 
      role="tabpanel" 
      aria-labelledby="contact-tab">
      <br>
      <div class="row">
        <div class="col-6">
          {{ profile_form.phone_1 | as_crispy_field }}
        </div>
        <div class="col-6">
          {{ profile_form.phone_2 | as_crispy_field }}
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          {{ profile_form.sos_contact | as_crispy_field }}
        </div>
        <div class="col-6">
          {{ profile_form.sos_phone | as_crispy_field }}
        </div>
      </div>
    </div>

    <div class="tab-pane fade" 
      id="address" 
      role="tabpanel" 
      aria-labelledby="address-tab">
      <br>
      <div class="row">
        <div class="col-8">
          {{ profile_form.address | as_crispy_field }}
        </div>
        <div class="col-4">
          {{ profile_form.number | as_crispy_field }}
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          {{ profile_form.complement | as_crispy_field }}
        </div>
        <div class="col-6">
          {{ profile_form.district | as_crispy_field }}
        </div>
      </div>
      <div class="row">
        <div class="col-8">
          {{ profile_form.city | as_crispy_field }}
        </div>
        <div class="col-4">
          {{ profile_form.state | as_crispy_field }}
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          {{ profile_form.country | as_crispy_field }}
        </div>
        <div class="col-6">
          {{ profile_form.zip_code | as_crispy_field }}
        </div>
      </div>
    </div>

    <div class="tab-pane fade" 
      id="other" 
      role="tabpanel" 
      aria-labelledby="other-tab">
      <br>
      <div class="row">
        <div class="col-4">
          {{ person_form.id_card | as_crispy_field }}
        </div>
        <div class="col-4">
          {{ person_form.birth | as_crispy_field }}
        </div>
        <div class="col-4">
          {{ profile_form.gender | as_crispy_field }}
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          {{ profile_form.profession | as_crispy_field }}
        </div>
        <div class="col-6">
          {{ profile_form.marital_status | as_crispy_field }}
        </div>
      </div>
      {{ person_form.observations | as_crispy_field }}
      {{ person_form.is_active | as_crispy_field }}
      {{ person_form.made_by | as_crispy_field }}
    </div>
    
  </div>
  
</form>

<script>
  //basic
  // label para e-mail input
  var hint_email = document.getElementById("hint_id_email");
  hint_email.innerHTML = "Enter a valid e-mail: your@mail.com";

  //fields
  const namePerson = document.getElementById("id_name")
  const socialPerson = document.getElementById("id_social_name")
  const emailPerson = document.getElementById("id_email")
  const phoneOnePerson = document.getElementById("id_phone_1")
  const phoneTwoPerson = document.getElementById("id_phone_2")
  const sosContact = document.getElementById("id_sos_contact")
  const sosPhone = document.getElementById("id_sos_phone")
  const birthDay = document.getElementById("id_birth")

  //main function
  function checkForm(){
    if(namePerson.value == ''){
      let message = "Don't forget this field."
      alertField("id_name", message);
      return false;
    }
    if(socialPerson.length < 2 || socialPerson.value == "" || socialPerson.value === null){
      let message = "Don't forget this field."
      alertField("id_social_name", message);
      return false;
    }
    if(emailPerson.value.indexOf("@") == -1 || emailPerson.value.indexOf(".") == -1 ||emailPerson.value == "" ||emailPerson.value == null
    ){
      let message = "enter with a valid e-mail: your@mail.com"
      alertField("id_email", message);
      return false;
    }
    if(phoneOnePerson.value.length < 10 || phoneOnePerson.value == "" || phoneOnePerson.value === null){
      let message = "enter with a valid phone number: xx-98765.4321"
      alertField("id_phone_1", message);
      return false;
    }
    if(phoneTwoPerson.value.length > 0 && phoneTwoPerson.value.length < 10) {
      let message = "enter with a valid phone number: xx-98765.4321"
      alertField("id_phone_2", message);
      return false;
    }
    if (sosContact.value) {
      if (sosPhone.value.length >= 0 && sosPhone.value.length < 10) {
        let message = "Don't forget this field."
        alertField("id_sos_phone", message);
        return false;
      }
    }
    if (sosPhone.value) {
      if (sosContact.value == "" || sosContact.value == null) {
        let message = "Don't forget this field."
        alertField("id_sos_contact", message);
        return false;
      }
    }
    if(birthDay.value == ''||birthDay.value === null){
      let message = "Don't forget this field."
      alertField('id_birth');
      return false;
    }


    document.getElementById('form').submit()
  }
  
  //handler function
  function alertField(input, message){
    const invalidField = document.getElementById(input)

    var invalidValueField = document.createElement("p");
    invalidValueField.classList.add("invalid-feedback");
    var invalidText = document.createTextNode(message);
    invalidValueField.appendChild(invalidText);
    invalidField.parentElement.appendChild(invalidValueField);
    invalidField.classList.add("is-invalid");
    invalidField.focus();
  }

  //Address filled by ZIP Code
  // aplicating function in tag
  let inputCep = document.querySelector("input[id=id_zip_code]");
  inputCep.addEventListener("change", searchZIPCode);

  // handlers functions
  function fillField(json) {
    document.querySelector("input[id=id_address]").value = json.logradouro;
    document.querySelector("input[id=id_district]").value = json.bairro;
    document.querySelector("input[id=id_complement]").value = json.complemento;
    document.querySelector("input[id=id_city]").value = json.localidade;
    document.querySelector("input[id=id_state]").value = json.uf;
  }

  // main function for ZIP code
  function searchZIPCode() {
    let inputCep = document.querySelector("input[id=id_zip_code]");
    let cep = inputCep.value.replace("-", "");

    let url = "http://viacep.com.br/ws/" + cep + "/json";

    let xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.onreadystatechange = function () {
      if (xhr.readyState == 4) {
        if (xhr.status == 200) fillField(JSON.parse(xhr.responseText));
      }
    };
    xhr.send();
  }
</script>